<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.73.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>kubernetes源码分析之informer(上篇) &middot; 静夜思</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://yinson123.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://yinson123.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://yinson123.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://yinson123.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://yinson123.github.io/"><h1>静夜思</h1></a>
      <p class="lead">
       且视他人之疑目如盏盏鬼火，大胆地去走你的夜路。 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://yinson123.github.io/">首页</a> </li>

      </ul>
    </nav>
	
	<div id="social" class="col span_6">
       <ul>
          <li><a href="https://github.com/Yinson123" target="_blank">GitHub</a></li>
          <li><a href="mailto: 908131753@qq.com" target="_blank">Mail Me</a></li>
        </ul>
     </div>

    <p>Copyright (c) 2020, Yinson</p>
	<p>Powered by Hugo 0.73.0</p>
	
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>kubernetes源码分析之informer(上篇)</h1>
  <time datetime=2020-08-02T10:31:11&#43;0800 class="post-date">Sun, Aug 2, 2020</time>
  <p>因为工作的原因，一直想好好阅读<a href="https://kubernetes.io/">kubernetes</a>的源码，看看这么强大的系统的内部机制，学习大神的优秀架构和优雅代码。</p>
<p><a href="https://github.com/kubernetes/client-go">client-go</a>在k8s中被广泛应用，kubernetes内部组件之间的通信，大部份依赖client-go中的<strong>list-watch</strong>机制。所以就先从clinet-go开始学习吧。</p>
<p><em>本文基于k8s <code>v1.18.6</code>版本，其中涉及到的主要代码大部分在client-go的<code>tool/cache</code>中。</em></p>
<h2 id="概述">概述</h2>
<p><strong>Infomer</strong>是client-go中的核心模块，通过它，所有的客户端实现了<strong>List-Watch</strong>方式监听apiserver中的资源。它的架构流程如下所示：</p>
<p><img src="../../img/informer.png" alt=""></p>
<ul>
<li>
<p><strong>Reflector</strong>: Reflector定义在 <code>cache</code> 包中(<em>tools/cache/reflector.go</em>)，它的作用是向 <code>apiserver </code>watch 特定的资源类型。这个功能通过其绑定的 <strong>List-Watch</strong>方法实现。<code>Watch</code>的资源可以是<code>in-build</code>的资源也可以是<code>custom</code>的资源。每次Reflector启动时，会对apiserver执行特定资源的list操作，而后通过watch机制，&ldquo;观察&quot;apiserver中的资源对象。当对象实例发生变更时，将变更&quot;放进&rdquo; Delta Fifo 队列。这个步骤在 watchHandler 函数(<em>tools/cache/reflector.go</em>)中完成。</p>
</li>
<li>
<p><strong>Informer</strong>： 一个定义在<code>cache</code>包中的基础<code>controller</code>(<em>tools/cache/controller.go</em>)。从 Delta FIFO 队列中pop资源对象实例(这个功能在 processLoop 中实现(<em>tools/cache/controller.go</em>)。这个 base controller做的工作是保存这个对象用于后续检索处理用的，然后触发我们自己的控制器来处理这个对象。</p>
</li>
<li>
<p><strong>Indexer</strong>: Indexer 提供的是 objects 之上的检索能力。Indexer 也定义在<code>cache</code>包中(<em>tools/cache/index.go</em>)。一个典型的检索使用方式是基于一个对象的 labels 创建索引。Indexer使用一个线程安全的store来存储对象和其对应的key。还有一个默认函数 <code>MetaNamespaceKeyFunc</code>(<em>tools/cache/store.go</em>) 可以生成对象的 key，类似 <!-- raw HTML omitted -->/<!-- raw HTML omitted --> 格式来关联对应的对象。</p>
</li>
<li>
<p><strong>Informer reference</strong>: 这是一个知道如何处理自定义资源对象的 Informer 实例的引用。自定义控制器需要创建合适的 Informer.</p>
</li>
<li>
<p><strong>Indexer reference</strong>: 这是一个知道如何处理自定义资源对象的 Indexer 实例的引用. 自定义控制器代码需要创建这个引用对象，然后用于检索资源对象用于后续的处理。</p>
</li>
<li>
<p><strong>Resource Event Handlers</strong>: 这是一个回调函数，在 Informer 想要分发一个对象给控制器的时候会调用这个函数。典型的用法是写一个函数来获取分发过来的对象的 key，将 key 放入队列中等待进一步的处理。</p>
</li>
<li>
<p><strong>Work queue</strong>: 这个队列是在自己的控制器代码中创建的，用来解耦一个对象的分发和处理过程。Resource event handler 函数会被写成提取分发来的对象的 key，然后将这个 key 添加到 work queue 里面。</p>
</li>
<li>
<p><strong>Process Item</strong> 这是我们在自己代码中实现的用来处理 work queue 中拿到的 items 的函数。这里可以有一个或多个函数来处理具体的过程，这个函数的典型用法是使用 Indexer 索引或者一个 Listing wrapper 来根据相应的 key 检索对象。</p>
</li>
</ul>
<h2 id="reflector">reflector</h2>
<p><strong>Reflector</strong>通过<strong>list-watch</strong>监听特定的资源，然后将变化写入<code>DeltaFIFO</code>中。</p>
<h3 id="定义">定义</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Reflector</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">// 在DeltaFIFO保存的对象类型，常常是对象的expectedGVK字段值，或者expectedType值。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">expectedTypeName</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">expectedType</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>
	<span style="color:#a6e22e">expectedGVK</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionKind</span>
	<span style="color:#75715e">// 存储对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">store</span> <span style="color:#a6e22e">Store</span>
	<span style="color:#a6e22e">listerWatcher</span> <span style="color:#a6e22e">ListerWatcher</span>

	<span style="color:#75715e">// 重试机制
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">backoffManager</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">BackoffManager</span>
	<span style="color:#75715e">// 每过一段时间，清空本地缓存，重新执行list，这样可以避免list&amp;watch机制错误导致业务逻辑错误
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
	<span style="color:#75715e">// 定义是否执行resync操作的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ShouldResync</span> <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// clock allows tests to manipulate time
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">clock</span> <span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">Clock</span>
	<span style="color:#75715e">// 是否采用分页（降低服务器压力）
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">paginatedResult</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// 最后一次同步获得的resource version值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lastSyncResourceVersion</span> <span style="color:#66d9ef">string</span>
	
	<span style="color:#a6e22e">isLastSyncResourceVersionUnavailable</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">// 对lastSyncResourceVersion读写操作时使用的读写锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lastSyncResourceVersionMutex</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
	<span style="color:#75715e">// Watch&amp;List时使用的分页大小
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">WatchListPageSize</span> <span style="color:#66d9ef">int64</span>
}
</code></pre></div><p>需要特别指出的是，在reflector结构体中，给了一个<code>backoffManager</code>字段，用于定义发生断联时的避免<strong>服务雪崩效应</strong>而采用的<strong>重试指数退避算法</strong>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewNamedReflector</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">lw</span> <span style="color:#a6e22e">ListerWatcher</span>, <span style="color:#a6e22e">expectedType</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">store</span> <span style="color:#a6e22e">Store</span>, <span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Reflector</span> {
	<span style="color:#a6e22e">realClock</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">RealClock</span>{}
	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Reflector</span>{
		<span style="color:#a6e22e">name</span>:          <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">listerWatcher</span>: <span style="color:#a6e22e">lw</span>,
		<span style="color:#a6e22e">store</span>:         <span style="color:#a6e22e">store</span>,
		<span style="color:#75715e">// We used to make the call every 1sec (1 QPS), the goal here is to achieve ~98% traffic reduction when
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// API server is not healthy. With these parameters, backoff will stop at [30,60) sec interval which is
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 0.22 QPS. If we don&#39;t backoff for 2min, assume API server is healthy and we reset the backoff.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">backoffManager</span>: <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NewExponentialBackoffManager</span>(<span style="color:#ae81ff">800</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>, <span style="color:#ae81ff">30</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>, <span style="color:#ae81ff">2.0</span>, <span style="color:#ae81ff">1.0</span>, <span style="color:#a6e22e">realClock</span>),
		<span style="color:#a6e22e">resyncPeriod</span>:   <span style="color:#a6e22e">resyncPeriod</span>,
		<span style="color:#a6e22e">clock</span>:          <span style="color:#a6e22e">realClock</span>,
	}
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">setExpectedType</span>(<span style="color:#a6e22e">expectedType</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>
}
</code></pre></div><p>在新建一个<code>reflector</code>对象的时候，<code>backoffManager</code>被设置成第一次为800ms间隔，如果访问失败，则访问间隔时间会加倍，并且加上一个随机值<code>Jitter</code>(避免服务同时刻执行重试)。同时，最大的间隔时间被设置成30秒，当超过2分钟还未响应时，会再次初始化<code>backoffManger</code>(初始间隔再次回到800ms)。感兴趣的同学可以自行查看这块代码实现(<em>k8s.io/apimachinery/pkg/util/wait/wait.go</em>)，这边就不再展开讲了。</p>
<h3 id="listwatch">List&amp;Watch</h3>
<p>在每一次启动时，reflector对象都会与apiserver建立http短链接，然后调用<code>list</code>方法，获取所有待观察对象的信息，并将<code>resourceVersion</code>值置为0；之后，再与apiserver建立长连接，每次对象实例发生变化时，server都将给reflector对象发生消息，&ldquo;通知&quot;实例变更。此后reflector将变更消息放置本地缓存<code>Delta Fifo Queue</code>中，待informer读取。List&amp;Watch主要代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reflector</span>) <span style="color:#a6e22e">ListAndWatch</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resourceVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">options</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{<span style="color:#a6e22e">ResourceVersion</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">relistResourceVersion</span>()}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">list</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>
		
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
		<span style="color:#a6e22e">listCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">panicCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">panicCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">r</span>
				}
			}()
			<span style="color:#a6e22e">pager</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pager</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">pager</span>.<span style="color:#a6e22e">SimplePageFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">opts</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>) (<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#66d9ef">error</span>) {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">listerWatcher</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">opts</span>)
			}))
			<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">list</span>, <span style="color:#a6e22e">paginatedResult</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pager</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">options</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isExpiredError</span>(<span style="color:#a6e22e">err</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">isTooLargeResourceVersionError</span>(<span style="color:#a6e22e">err</span>) {
				<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">setIsLastSyncResourceVersionUnavailable</span>(<span style="color:#66d9ef">true</span>)
				<span style="color:#a6e22e">list</span>, <span style="color:#a6e22e">paginatedResult</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pager</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{<span style="color:#a6e22e">ResourceVersion</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">relistResourceVersion</span>()})
			}
			close(<span style="color:#a6e22e">listCh</span>)
		}()
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">panicCh</span>:
			panic(<span style="color:#a6e22e">r</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">listCh</span>:
		}
		
		<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">ExtractList</span>(<span style="color:#a6e22e">list</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">syncWith</span>(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">resourceVersion</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s: Unable to sync list result: %v&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span>)
		}
		<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">resyncerrc</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">error</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">cancelCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">cancelCh</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">resyncCh</span>, <span style="color:#a6e22e">cleanup</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">resyncChan</span>()
		<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#a6e22e">cleanup</span>() <span style="color:#75715e">// Call the last one written into cleanup
</span><span style="color:#75715e"></span>		}()
		<span style="color:#66d9ef">for</span> {
			<span style="color:#66d9ef">select</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">resyncCh</span>:
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>:
				<span style="color:#66d9ef">return</span>
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">cancelCh</span>:
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ShouldResync</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ShouldResync</span>() {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Resync</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">resyncerrc</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">err</span>
					<span style="color:#66d9ef">return</span>
				}
			}
			<span style="color:#a6e22e">cleanup</span>()
			<span style="color:#a6e22e">resyncCh</span>, <span style="color:#a6e22e">cleanup</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">resyncChan</span>()
		}
	}()

	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		<span style="color:#66d9ef">default</span>:
		}

		<span style="color:#a6e22e">timeoutSeconds</span> <span style="color:#f92672">:=</span> int64(<span style="color:#a6e22e">minWatchTimeout</span>.<span style="color:#a6e22e">Seconds</span>() <span style="color:#f92672">*</span> (<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Float64</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.0</span>))
		<span style="color:#a6e22e">options</span> = <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{
			<span style="color:#a6e22e">ResourceVersion</span>: <span style="color:#a6e22e">resourceVersion</span>,
			<span style="color:#a6e22e">TimeoutSeconds</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">timeoutSeconds</span>,
			<span style="color:#a6e22e">AllowWatchBookmarks</span>: <span style="color:#66d9ef">true</span>,
		}

		<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">Now</span>()
		<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">listerWatcher</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">options</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">switch</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">isExpiredError</span>(<span style="color:#a6e22e">err</span>):		
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span>:
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ErrUnexpectedEOF</span>:
			<span style="color:#66d9ef">default</span>:
				<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s: Failed to watch %v: %v&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">expectedTypeName</span>, <span style="color:#a6e22e">err</span>))
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">utilnet</span>.<span style="color:#a6e22e">IsConnectionRefused</span>(<span style="color:#a6e22e">err</span>) {
				<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">watchHandler</span>(<span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">w</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">resourceVersion</span>, <span style="color:#a6e22e">resyncerrc</span>, <span style="color:#a6e22e">stopCh</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">errorStopRequested</span> {
				<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			}
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}
	}
}
</code></pre></div><p>代码稍微有点长，省略大部分细节的业务代码后，可以看到，<code>ListAndWatch</code>方法主要做的就是先调用list方法，将需观察的实例对象做一次List操作，更新至reflector的store，同时更新<code>resourceVersion</code>值。之后，在for循环内，一直执行<code>watch</code>操作。</p>
<p>在这里又有一个技巧：reflecor中的<code>listerWatcher</code>被定义成interface，只需实现两个方法：<code>Lister</code>和<code>watcher</code>，这样就有一个好处，对于不同的资源执行list和watch时，可以使用不同的方法，用户甚至可以使用自己定义的方法(后续会提到)。在执行<code>List</code>和<code>Watch</code>时，直接传入定义的方法，实现较为巧妙。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reflector</span>) <span style="color:#a6e22e">watchHandler</span>(<span style="color:#a6e22e">start</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">w</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#a6e22e">resourceVersion</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">errc</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">loop</span>:
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errorStopRequested</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">errc</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">event</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">ResultChan</span>():
			<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">newResourceVersion</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">GetResourceVersion</span>()
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Type</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Added</span>:
				<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>)
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s: unable to add watch event object (%#v) to store: %v&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">err</span>))
				}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Modified</span>:
				<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>)
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s: unable to update watch event object (%#v) to store: %v&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">err</span>))
				}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Deleted</span>:
				<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>)
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s: unable to delete watch event object (%#v) from store: %v&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">err</span>))
				}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Bookmark</span>:
				<span style="color:#75715e">// A `Bookmark` means watch has synced here, just update the resourceVersion
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">default</span>:
				<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s: unable to understand watch event %#v&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">event</span>))
			}
			<span style="color:#f92672">*</span><span style="color:#a6e22e">resourceVersion</span> = <span style="color:#a6e22e">newResourceVersion</span>
			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">setLastSyncResourceVersion</span>(<span style="color:#a6e22e">newResourceVersion</span>)
			<span style="color:#a6e22e">eventCount</span><span style="color:#f92672">++</span>
		}
	}

	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><code>watchHandler</code>逻辑很清晰，就是将<code>watch</code>到发生变化的资源对象更新到<strong>DeltaFIFO</strong>中。</p>
<h2 id="informer">Informer</h2>
<p>在这里有一点容易引起误会：在上图中执行<code>Pop Object</code>和<code>Add Object</code>的对象在代码里是一个<code>controller</code>对象，同时，我们可以看到代码中还有一个<code>Controller</code>的interface。仔细看我们可以发现，<code>controller</code>是<code>Controller</code>的一个实例，它实现了<code>Run</code>，<code>HasSynced</code>和<code>LastSyncResourceVersion</code>方法。同时，在这里它也是<code>informer</code>对象的实例。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">controller</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>.<span style="color:#a6e22e">Close</span>()
	}()
	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewReflector</span>(
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ListerWatcher</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ObjectType</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">FullResyncPeriod</span>,
	)
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ShouldResync</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShouldResync</span>
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">clock</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">clock</span>

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflectorMutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflector</span> = <span style="color:#a6e22e">r</span>
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflectorMutex</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Group</span>
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()

	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">StartWithChannel</span>(<span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Run</span>)

	<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">processLoop</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
}
</code></pre></div><p>最主要的方法就是<code>Run</code>，可以看到上面提到的<code>reflector</code>在这里被定义，同时，<code>wg.StartWithChannel(stopCh, r.Run)</code>执行<code>ListAndWatch</code>方法。</p>
<p>看一下<code>processLoop</code>方法的实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">controller</span>) <span style="color:#a6e22e">processLoop</span>() {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>.<span style="color:#a6e22e">Pop</span>(<span style="color:#a6e22e">PopProcessFunc</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Process</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">ErrFIFOClosed</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">RetryOnError</span> {
				<span style="color:#75715e">// This is the safe way to re-enqueue.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>.<span style="color:#a6e22e">AddIfNotPresent</span>(<span style="color:#a6e22e">obj</span>)
			}
		}
	}
}
</code></pre></div><p>在看<code>Pop</code>方法具体实现之前，建议先看一下<code>DeltaFIFO</code>。有关<code>DeltaFIFO</code>的介绍，建议收看博客<a href="https://www.jianshu.com/p/095de3ee5f7b">informer之delta_fifo</a>，非常详细。需要指出的是，<code>DeltaFIFO</code>中只记录<code>Dalta</code>数据，表示<code>obj</code>的变化值，同时本地还有一份缓存<code> knownObjects</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeltaFIFO</span>) <span style="color:#a6e22e">Pop</span>(<span style="color:#a6e22e">process</span> <span style="color:#a6e22e">PopProcessFunc</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">for</span> len(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">IsClosed</span>() {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrFIFOClosed</span>
			}

			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Wait</span>()
		}
		<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>[<span style="color:#ae81ff">0</span>]
		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">queue</span>[<span style="color:#ae81ff">1</span>:]
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">initialPopulationCount</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">initialPopulationCount</span><span style="color:#f92672">--</span>
		}
		<span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">id</span>]
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#75715e">// Item may have been deleted subsequently.
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">continue</span>
		}
		delete(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">id</span>)
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">item</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#a6e22e">ErrRequeue</span>); <span style="color:#a6e22e">ok</span> {
			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">addIfNotPresent</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">item</span>)
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Err</span>
		}
		<span style="color:#75715e">// Don&#39;t need to copyDeltas here, because we&#39;re transferring
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// ownership to the caller.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">err</span>
	}
}
</code></pre></div><p>功能单一，将<strong>DeltaFIFO</strong>队列中的元素取出，完成自定义的process操作。有个小细节，当<code>queue</code>队列长度为0时，会通过<code>cond</code>执行等待，等到<code>list</code>执行<code>Add</code>,<code>Update</code>等操作后，通知继续往下。</p>
<p>接下来看一下<code>process</code>的实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#a6e22e">Process</span>:
	<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
		<span style="color:#75715e">// from oldest to newest
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#a6e22e">Deltas</span>) {
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">Replaced</span>, <span style="color:#a6e22e">Added</span>, <span style="color:#a6e22e">Updated</span>:
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span> {
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
					}
					<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">OnUpdate</span>(<span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
					}
					<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">OnAdd</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
				}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Deleted</span>:
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">OnDelete</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
			}
		}
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
</code></pre></div><p>执行<code>Sync</code>，<code>Replaced</code>,  <code>Added</code>,  <code>Updated</code>操作时，若发现<code>store</code>中不存在，则会自动创建，否则执行更新；执行<code>Deleted</code>操作时，则直接执行删除。在这里，<code>Sync</code>，<code>Replaced</code>都是在执行<code>watch</code>失败之后，执行重新执行<code>list</code>操作后，进行的缓存同步。但同时，<code>sync</code>也会根据定义<code>informer</code>是定义的同步刷新时间来定时执行刷新。大部分情况下，用户都定义为0(信任<strong>etcd</strong>的刷新机制)。</p>
<h2 id="indexer">Indexer</h2>
<p>上面执行对本地<code>store</code>的操作对象 <code>clientState</code>其实就是上面提到的<code>indexer</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewIndexerInformer</span>(
	<span style="color:#a6e22e">lw</span> <span style="color:#a6e22e">ListerWatcher</span>,
	<span style="color:#a6e22e">objType</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>,
	<span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>,
	<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ResourceEventHandler</span>,
	<span style="color:#a6e22e">indexers</span> <span style="color:#a6e22e">Indexers</span>,
) (<span style="color:#a6e22e">Indexer</span>, <span style="color:#a6e22e">Controller</span>) {
	<span style="color:#75715e">// This will hold the client state, as we know it.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">clientState</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewIndexer</span>(<span style="color:#a6e22e">DeletionHandlingMetaNamespaceKeyFunc</span>, <span style="color:#a6e22e">indexers</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">clientState</span>, <span style="color:#a6e22e">newInformer</span>(<span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">objType</span>, <span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">clientState</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewIndexer</span>(<span style="color:#a6e22e">keyFunc</span> <span style="color:#a6e22e">KeyFunc</span>, <span style="color:#a6e22e">indexers</span> <span style="color:#a6e22e">Indexers</span>) <span style="color:#a6e22e">Indexer</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cache</span>{
		<span style="color:#a6e22e">cacheStorage</span>: <span style="color:#a6e22e">NewThreadSafeStore</span>(<span style="color:#a6e22e">indexers</span>, <span style="color:#a6e22e">Indices</span>{}),
		<span style="color:#a6e22e">keyFunc</span>:      <span style="color:#a6e22e">keyFunc</span>,
	}
}
</code></pre></div><p>可以看到informer中对于<code>store</code>中存储的对象的操作都被定义在<code>indexer</code>里。<code>Indexer</code>其实是<code>cache</code>的一个实现。</p>
<p>在这里，<code>threadSafeMap</code>实现了<code>ThreadSafeStore</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewThreadSafeStore</span>(<span style="color:#a6e22e">indexers</span> <span style="color:#a6e22e">Indexers</span>, <span style="color:#a6e22e">indices</span> <span style="color:#a6e22e">Indices</span>) <span style="color:#a6e22e">ThreadSafeStore</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">threadSafeMap</span>{
		<span style="color:#a6e22e">items</span>:    <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{},
		<span style="color:#a6e22e">indexers</span>: <span style="color:#a6e22e">indexers</span>,
		<span style="color:#a6e22e">indices</span>:  <span style="color:#a6e22e">indices</span>,
	}
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">threadSafeMap</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">lock</span>  <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
	<span style="color:#a6e22e">items</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}

	<span style="color:#75715e">// indexers maps a name to an IndexFunc
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">indexers</span> <span style="color:#a6e22e">Indexers</span>
	<span style="color:#75715e">// indices maps a name to an Index
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">indices</span> <span style="color:#a6e22e">Indices</span>
}
</code></pre></div><p>顺便看一下，它的<code>Add</code>方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">threadSafeMap</span>) <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#a6e22e">oldObject</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">key</span>]
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">items</span>[<span style="color:#a6e22e">key</span>] = <span style="color:#a6e22e">obj</span>
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">updateIndices</span>(<span style="color:#a6e22e">oldObject</span>, <span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">threadSafeMap</span>) <span style="color:#a6e22e">updateIndices</span>(<span style="color:#a6e22e">oldObj</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">newObj</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#75715e">// if we got an old object, we need to remove it before we add it again
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">oldObj</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">deleteFromIndices</span>(<span style="color:#a6e22e">oldObj</span>, <span style="color:#a6e22e">key</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">indexFunc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">indexers</span> {
		<span style="color:#a6e22e">indexValues</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">indexFunc</span>(<span style="color:#a6e22e">newObj</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			panic(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unable to calculate an index entry for key %q on index %q: %v&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span>))
		}
		<span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">indices</span>[<span style="color:#a6e22e">name</span>]
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">index</span> = <span style="color:#a6e22e">Index</span>{}
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">indices</span>[<span style="color:#a6e22e">name</span>] = <span style="color:#a6e22e">index</span>
		}

		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">indexValue</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">indexValues</span> {
			<span style="color:#a6e22e">set</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">index</span>[<span style="color:#a6e22e">indexValue</span>]
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">set</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">set</span> = <span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">String</span>{}
				<span style="color:#a6e22e">index</span>[<span style="color:#a6e22e">indexValue</span>] = <span style="color:#a6e22e">set</span>
			}
			<span style="color:#a6e22e">set</span>.<span style="color:#a6e22e">Insert</span>(<span style="color:#a6e22e">key</span>)
		}
	}
}
</code></pre></div><p>代码很眼熟，没错，<code>threadSafeMap</code>就是另一种形式的<code>reflector</code>。</p>

</div>


    </main>

    
      
    
  </body>
</html>
